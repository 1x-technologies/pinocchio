SET(PYTHON_EXECUTABLE @PYTHON_EXECUTABLE@)
SET(MEMORYCHECK_COMMAND @MEMORYCHECK_COMMAND@)
SET(PYTHON_TEST_SCRIPT @PYTHON_TEST_SCRIPT@)

execute_process(COMMAND
  ${MEMORYCHECK_COMMAND} -- ${PYTHON_EXECUTABLE} ${PYTHON_TEST_SCRIPT}
  ERROR_VARIABLE MEMORYCHECK_OUTPUT)

string(FIND "${MEMORYCHECK_OUTPUT}" "definitely lost: 0 bytes in 0 blocks" DEFINITELY_LOST)
string(FIND "${MEMORYCHECK_OUTPUT}" "indirectly lost: 0 bytes in 0 blocks" INDIRECTLY_LOST)

if(${DEFINITELY_LOST} GREATER -1 AND ${INDIRECTLY_LOST} GREATER -1)
  message(STATUS "${PYTHON_TEST_SCRIPT} is not leaking memory")
else()
  message(FATAL_ERROR "Output: ${MEMORYCHECK_OUTPUT}\n"
    "${PYTHON_TEST_SCRIPT} is leaking memory\n")
endif()
